 **Invariants Table** — the constitution of Anchor OS (v1.5 sweet-spot version).  
Every proposed change, PR, or relaxation must be measured against this table.  
If it violates any row, it **does not ship**. Period.

This version incorporates your feedback and the refinements from the conversation (tighter wording, no contradictions, mechanical enforcement, visible state, cheaper revocation, bounded lifetime, flat passports).  
More detail = more defense against bikeshedding or future drift.

| #  | Category                  | Invariant (Non-Negotiable Truth)                                                                                          | Immutable / Mutable | Ephemeral / Persistent | Ambient / Explicit | Cross-Room Allowed?                          | Enforcement Mechanism / Failure Mode                                                                 | Why This Must Never Be Violated |
|----|---------------------------|---------------------------------------------------------------------------------------------------------------------------|---------------------|-------------------------|--------------------|----------------------------------------------|------------------------------------------------------------------------------------------------------|---------------------------------|
| 1  | Base (Spine)              | The base (UKI + spine.sqsh) is immutable at runtime — never writable, never modified after switch_root                    | Immutable           | Runtime-ephemeral (read-only squashfs mounted) | N/A                | N/A                                          | dm-verity verifies every block read → kernel panic on mismatch                                       | Any runtime mutation breaks the entire trust chain (no recovery possible without physical access) |
| 2  | Root Filesystem           | Root filesystem is always read-only after switch_root into spine.sqsh                                                     | Immutable           | Ephemeral              | N/A                | N/A                                          | bay0 calls remount_root_readonly() immediately after switch_root → panic on write attempt           | Runtime write to / enables persistence attacks and drift in the trusted base |
| 3  | Loadable Kernel Modules   | No loadable kernel modules allowed under any circumstances (CONFIG_MODULES=no)                                            | Immutable           | N/A                    | N/A                | N/A                                          | Kernel config disables modules; seccomp denies init_module/finit_module as defense-in-depth         | LKM = ring-0 code injection vector; even in a room, it compromises the shared kernel |
| 4  | PID 1 Authority           | bay0 is the only PID 1 process; its death causes kernel panic / reboot (no recovery or restart path)                      | Immutable           | N/A                    | N/A                | N/A                                          | PID 1 exit → kernel panic; no supervisor or fallback                                                | PID 1 compromise = total system compromise; no safe restart possible |
| 5  | Room Persistence          | Room state (tmpfs overlay, caches, runtime files) is always ephemeral; destroyed on close / kill / reboot                 | Mutable (inside room) | Ephemeral              | N/A                | N/A                                          | tmpfs unmount on close/kill → all data erased from RAM; no persistent backing store                 | Malware persistence or cross-session tracking becomes impossible |
| 6  | Cross-Room Data Flow      | Data may only cross rooms via explicit mechanisms (courier by default; shared folders as constrained subclass)            | N/A                 | Ephemeral (courier) / Persistent (vault-backed shared) | Explicit           | Only via courier or passport-declared shared folder | Courier process dies after transfer; shared folders require passport + one-time prompt for write   | Silent or ambient cross-room channels enable lateral movement and data exfil |
| 7  | Ambient IPC / Clipboard   | No ambient clipboard, drag-drop, shared memory, or persistent IPC between rooms                                           | N/A                 | Ephemeral              | Explicit           | Never ambient                                | No shared tmpfs, no shared sockets, no shared /dev/shm; session clipboard requires passport + auto-clear | Ambient channels are the #1 covert exfil and tracking vector |
| 8  | Shared Folders            | Shared folders must be explicit, scoped, read-only by default, one-time consent for write, fixed mount points             | Mutable (inside room) | Persistent only if vault-backed | Explicit           | Only via passport-declared shared folder     | Passport declaration + one-time prompt for write; fixed target paths (/mnt/shared/<name>)           | Arbitrary shared mounts enable path confusion and escalation attacks |
| 9  | Persistent Mounts         | Persistent mounts (e.g. ~/.config, ~/Downloads) must be explicit in passport and vault-backed                              | Mutable (inside room) | Persistent (vault)     | Explicit           | Scoped to room                               | Bind-mount from vault subvolume; scoped by room ID; one-time user prompt                            | Uncontrolled persistence enables malware or tracking survival across reboots |
| 10 | Vault Access              | Vault is only accessible via explicit bind-mount from subvolume; never ambient or globally mounted                        | Immutable (encrypted) | Persistent             | Explicit           | Scoped to room                               | TPM-sealed LUKS2 + passphrase; subvolume per room; no global /vault mount in bay0                   | Global vault access = total data exfil on compromise |
| 11 | Capability Escalation     | No room can gain new capabilities at runtime (passports are spawn-time only, no conditionals/scripting)                 | Immutable           | N/A                    | Explicit           | Never                                        | Passport parsed once at spawn; no runtime policy change; flat TOML only                             | Runtime policy change = privilege escalation vector |
| 12 | Network Access            | Network access must be explicit (passport: none, wan-only, lan-only, full)                                                | N/A                 | Ephemeral              | Explicit           | Scoped by passport                           | Separate netns + nftables rules enforced at spawn; veth pair to net-gateway room                    | Uncontrolled network = exfil, lateral movement, tracking |
| 13 | Device Access             | Device access (GPU, camera, mic, USB) must be explicit in passport; bind-mount only allowed devices                       | N/A                 | Ephemeral              | Explicit           | Scoped by passport                           | Bind-mount only allowed devices; seccomp deny mknod; drop CAP_MKNOD/CAP_SYS_ADMIN                   | Unauthorized device access = privacy breach or DMA attack |
| 14 | Syscall Access            | Syscalls are restricted via seccomp (allowlist per passport)                                                              | Immutable           | N/A                    | Explicit           | N/A                                          | seccomp filter applied at spawn; deny by default                                                    | Unrestricted syscalls = kernel attack surface expansion |
| 15 | Ambient Authority         | No ambient authority (no global shared resources, no default allow)                                                       | Immutable           | N/A                    | Explicit           | Never                                        | Default deny everything; explicit allow only via passport                                           | Ambient authority = the root cause of most modern exploits |
| 16 | Runtime Flexibility       | Runtime flexibility exists only inside rooms; base has zero runtime flexibility                                            | Immutable (base)    | Ephemeral (rooms)      | Explicit           | N/A                                          | Base is read-only; rooms are tmpfs + explicit mounts                                                | Runtime flexibility in base = drift + attack surface growth |
| 17 | Update Mechanism          | Updates are atomic whole-image replace (A/B slots + watchdog rollback)                                                    | Immutable           | Ephemeral              | Explicit           | N/A                                          | Watchdog timeout → auto-revert to known-good slot                                                   | Incremental updates = partial state + drift risk |
| 18 | Auditability              | bay0 codebase must stay <3k LOC (to preserve auditability and reduce attack surface)                                     | Immutable           | N/A                    | N/A                | N/A                                          | CI enforces LOC cap; passports are flat TOML only                                                   | Large codebase = un-auditable attack surface |

### Summary of the Constitution

- **Immutable**: The base (Spine), passports, syscall filters, kernel config, update mechanism  
- **Mutable**: Only inside rooms (tmpfs), and only if explicitly allowed via passport (vault mounts, shared folders)  
- **Ephemeral**: All room state, courier processes, clipboard (if enabled), tmpfs overlays  
- **Persistent**: Only explicit Vault subvolumes (user data, saved models, bookmarks, etc.)  
- **Ambient**: Nothing — every cross-room flow is explicit, named, scoped, and timed  
- **Cross-room**: Only via courier (one-shot, dies after transfer) or explicit shared folders (read-only default)  

This table is the final constitution.  
Any change that violates even one row **does not ship**.  
That's how Anchor stays Anchor — no drift, no creep, no vibe-based exceptions.
